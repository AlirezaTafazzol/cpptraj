#!/bin/bash
# CPPTRAJ configure script
# Daniel R. Roe
# 2010-11-18
# Simple script to set compiler vars. Create config.h, which will be used
# by src/Makefile and test/Makefile.
# Usage: ./configure [gnu/intel] OPTIONS

# Print help message
Usage() {
  echo "Usage: ./configure [gnu/intel] OPTIONS"
  echo "   OPTIONS:"
  echo "   --help     : Display this message."
  echo "   -d, -debug : Turn on compiler debugging info"
  echo "   -debugon   : Add -DDEBUG flag to activate internal debugging"
  echo "   -noopt     : Do not use optimized compiler flags (default when -d specified)"
  echo "   -nobzlib   : Do not use Bzip2"
  echo "   -nozlib    : Do not use zlib (gzip/zip)"
  echo "   -nonetcdf  : Do not use netcdf"
  echo "   -nolfs     : Do not enable large file support."
  echo "      Static linking options:"
  echo "   --with-netcdf=<DIR>"
  echo "   --with-zlib=<DIR>"
  echo "   --with-bzlib=<DIR>"
  echo ""
  echo "   EXPERIMENTAL OPTIONS:"
  echo "   -profile   : Use Gnu compiler profiling (>= V4.5)"
  echo "   -mpi       : Use mpicc/mpicxx to compile."
  echo "   -openmp    : Use openmp for parallelization of certain routines."
  echo "   NOTE: -openmp and -mpi are mutually exclusive."
  echo "   --with-hdf5=<DIR>"
}

# If arg is Key=Value, separate into Key and Value
ParseArg() {
  KEY=`echo "$1" | awk 'BEGIN{FS = "=";}{print $1;}'`
  VALUE=`echo "$1" | awk 'BEGIN{FS = "=";}{print $2;}'`
  if [[ $VALUE = $KEY ]] ; then
    VALUE=""
  fi
}

# Write a C or C++ program to test compiler and flags
# Arg should be file to write test program to, testp.c or testp.cpp.
WriteTestProgram() {
  if [[ $1 = "testp.c" ]] ; then
    STDIO="<stdio.h>"
  elif [[ $1 = "testp.cpp" ]] ; then 
    STDIO="<cstdio>"
  fi
  
  cat > $1 <<EOF
#include $STDIO
#ifdef HASBZ2
#  include "bzlib.h"
#endif
#ifdef HASGZ
#  include "zlib.h"
#endif
#ifdef BINTRAJ
#  include "netcdf.h"
#endif

int main() {
#ifdef HASBZ2
  BZFILE *bfile;
  bfile=NULL;
#endif
#ifdef HASGZ
  gzFile gfile;
  gfile=NULL;
#endif
  printf("Testing\n");
#ifdef BINTRAJ
  printf("%s\n",nc_strerror(0));
#endif
  return 0;
}
EOF
}

# Test compilation with flags
TestCompile() {
  # C
  echo "Testing C compiler:"
  WriteTestProgram testp.c
  $CC $CFLAGS -o testp testp.c $BZLIB $NETCDFLIB $ZLIB 
  ./testp | grep "Testing" > /dev/null
  status=$?
  if [[ $status -gt 0 ]] ; then
      echo "  Error: Unable to compile a C program using:"
      echo "       $CC $CFLAGS $ZLIB $BZLIB $NETCDFLIB"
      echo "       Please check your compiler settings or configure flags."
      echo "       If errors/warnings appear above related to netcdf.h, zlib.h,"
      echo "       or bzlib.h check that your compiler is able to find the "
      echo "       correct libraries."
      echo ""
      exit 1
  fi
  /bin/rm -f testp.c testp
  echo "  OK"

  # C++
  echo "Testing C++ compiler:"
  WriteTestProgram testp.cpp
  $CXX $CXXFLAGS -o testp testp.cpp $BZLIB $NETCDFLIB $ZLIB
  ./testp | grep "Testing" > /dev/null
  status=$?
  if [[ $status -gt 0 ]] ; then
      echo "  Error: Unable to compile a C++ program using:"
      echo "       $CXX $CXXFLAGS $ZLIB $BZLIB $NETCDFLIB"
      echo "       Please check your compiler settings or configure flags."
      echo "       If errors/warnings appear above related to netcdf.h, zlib.h,"
      echo "       or bzlib.h check that your compiler is able to find the "
      echo "       correct libraries."
      echo ""
      exit 1
  fi
  /bin/rm -f testp.cpp testp
  echo "  OK"
}

#---------------------------------------------------------------------

if [[ -z $1  || $1 = "--help" ]] ; then
  Usage
  exit 0
fi

CONFIGURECMD="$*"

KEY=""
VALUE=""
echo ""

# Process Options
OPT=1
CC=""
CXX=""
CPPTRAJHOME=`pwd`
CPPTRAJBIN=$CPPTRAJHOME/bin
DIRECTIVES=""
DBGFLAGS=""
OPTFLAGS=""
OMPFLAGS=""
LDFLAGS=""
BZLIB="-lbz2"
ZLIB="-lz"
NETCDFLIB="-lnetcdf"
#HDF5LIB="-lhdf5_hl -lhdf5"
HDF5LIB=""
LFS="-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"
INCLUDE=""
USEMPI=0
USEOPENMP=0
PROFILE=0
while [[ ! -z $1 ]] ; do
  ParseArg $1
  case "$KEY" in
    "gnu" )
      echo "Using gnu compilers"
      CC=gcc
      CXX=g++
      OPTFLAGS="-O3 -Wall"
      OMPFLAGS="-fopenmp"
      ;;
    "intel" )
      echo "Using intel compilers"
      CC=icc
      CXX=icpc
      OPTFLAGS="-O3 -Wall"
      OMPFLAGS="-openmp"
      ;; 
    "-debug" | "-d" ) 
      echo "Turning on compiler debug info"
      echo "Turning off optimization"
      DBGFLAGS="-g -Wall"
      OPT=0
      ;;
    "-debugon"      ) 
      echo "Turning on cpptraj internal debug info"
      DIRECTIVES="$DIRECTIVES -DDEBUG" 
      ;;
    "-noopt"          ) 
      echo "Turning off optimization"
      OPT=0 
      ;;
    "-mpi"          )
      USEMPI=1
      USEOPENMP=0
      ;;
    "-openmp"       )
      USEOPENMP=1
      USEMPI=0
      ;;
    "-profile"      ) PROFILE=1 ;;
    "-nolfs"        )
      echo "Disabling large file support"
      LFS=""
      ;;
    "-nobzlib"      )
      echo "Not using bzip2"
      BZLIB=""
    ;;
    "-nozlib"       )
      echo "Not using zlib (gzip/zip)"
      ZLIB=""
      ;;
    "-nonetcdf"     )
      echo "Not using netcdf"
      NETCDFLIB=""
      ;;
    "--with-bzlib"  )
      INCLUDE="$INCLUDE -I$VALUE/include"
      BZLIB="-I$VALUE/include $VALUE/lib/libbz2.a"
      echo "Using BZIP2: $BZLIB"
      ;;
    "--with-zlib" )
      INCLUDE="$INCLUDE -I$VALUE/include"
      ZLIB="-I$VALUE/include $VALUE/lib/libz.a"
      echo "Using ZLIB: $ZLIB"
      ;;
    "--with-netcdf" )
      INCLUDE="$INCLUDE -I$VALUE/include"
      NETCDFLIB="-I$VALUE/include $VALUE/lib/libnetcdf.a"
      echo "Using NETCDFLIB: $NETCDFLIB"
      ;;
    "--with-hdf5" )
      INCLUDE="$INCLUDE -I$VALUE/include"
      HDF5LIB="-I$VALUE/include $VALUE/lib/libhdf5_hl.a $VALUE/lib/libhdf5.a -lm"
      echo "Using HDF5LIB: $HDF5LIB"
      ;;
    * )
      echo "Unrecognized OPTION: $1"
      exit 1
      ;;
  esac
  shift
done

# Check for compilers
if [[ -z $CC || -z $CXX ]] ; then
  echo "No compiler specified."
  echo "Specify 'gnu' or 'intel' as an argument to ./configure"
  Usage
  exit 1
fi

# Remove opt flags if specified
if [[ $OPT -eq 0 ]] ; then
  OPTFLAGS=""
fi

# If no netcdf specified and AMBERHOME defined use netcdf from AMBERHOME
#if [[ $NETCDFLIB = "-lnetcdf" && ! -z $AMBERHOME ]] ; then
#  echo "Using netcdf from AMBERHOME: $AMBERHOME"
#  INCLUDE="$INCLUDE -I$AMBERHOME/AmberTools/src/netcdf/include"
#  NETCDFLIB="-I$AMBERHOME/AmberTools/src/netcdf/include $AMBERHOME/AmberTools/src/netcdf/lib/libnetcdf.a"
#fi

# Add HDF5 flags to NETCDF
if [[ ! -z $NETCDFLIB ]] ; then
  NETCDFLIB="$NETCDFLIB $HDF5LIB"
fi

# Add directives
if [[ ! -z $BZLIB ]] ; then
  DIRECTIVES="$DIRECTIVES -DHASBZ2"
fi
if [[ ! -z $ZLIB ]] ; then
  DIRECTIVES="$DIRECTIVES -DHASGZ"
fi
if [[ ! -z $NETCDFLIB ]] ; then
  DIRECTIVES="$DIRECTIVES -DBINTRAJ"
fi

# Change compilers for MPI if specified
if [[ $USEMPI -eq 1 ]] ; then
  echo "Using MPI"
  CC=mpicc
  CXX=mpicxx
  DIRECTIVES="$DIRECTIVES -DMPI"
fi

# Add flags for OPENMP if specified
if [[ $USEOPENMP -eq 1 ]] ; then
  echo "Using OPENMP"
  DIRECTIVES="$OMPFLAGS $DIRECTIVES"
  LDFLAGS="$OMPFLAGS $LDFLAGS"
fi

CFLAGS="$DBGFLAGS $OPTFLAGS $DIRECTIVES $LFS $INCLUDE"
CXXFLAGS="$DBGFLAGS $OPTFLAGS $DIRECTIVES $LFS $INCLUDE"

# Turn on profiling if specified
if [[ $PROFILE -eq 1 && $CXX = "g++" ]] ; then
  echo "Using $CC profiling."
  CXXFLAGS="-D_GLIBCXX_PROFILE $CXXFLAGS"
fi

# Test compilers
TestCompile

# Write config.h
cat > config.h <<EOF
# config.h for cpptraj
# configured using args: "$CONFIGURECMD"

CPPTRAJHOME=$CPPTRAJHOME
CPPTRAJBIN=$CPPTRAJBIN

CC=$CC
CXX=$CXX
CFLAGS=$CFLAGS
CXXFLAGS=$CXXFLAGS
ZLIB=$ZLIB
BZLIB=$BZLIB
NETCDFLIB=$NETCDFLIB

LDFLAGS=$LDFLAGS
SFX=

EOF

# Create directories if necessary
if [[ ! -e $CPPTRAJBIN ]] ; then
  mkdir $CPPTRAJBIN
fi

echo ""
exit 0
