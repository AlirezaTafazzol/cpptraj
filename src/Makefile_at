include ../../config.h

CPPTRAJ_FLAGS=-I$(INCDIR) $(COPTFLAGS) $(CFLAGS)
# The following are needed for the ptraj_analyze routines
PTRAJ_OBJECTS=thermo.o pubfft.o
# These libraries are also in the FLIBS_PTRAJ line, but since the
# FLIBS_PTRAJ line also contains other linking flags use
# EXTERNAL_LIBS for dependencies, FLIBS_PTRAJ for linking.
EXTERNAL_LIBS=$(LIBDIR)/arpack.a $(LIBDIR)/lapack.a $(LIBDIR)/blas.a

include cpptrajfiles

all: cpptraj$(SFX)

install: cpptraj$(SFX) 
	mv cpptraj$(SFX) $(BINDIR)/ 

findDepend: FindDepend.o
	$(CXX) -Wall -o findDepend FindDepend.o

depend: findDepend
	./findDepend $(SOURCE) > cpptrajdepend

dependclean:
	-/bin/rm FindDepend.o
	-/bin/rm findDepend

cpptraj$(SFX): $(NETCDFLIB) $(OBJECTS) $(PTRAJ_OBJECTS) $(EXTERNAL_LIBS) 
	$(CXX) $(LDFLAGS) -o cpptraj$(SFX) $(OBJECTS) $(PTRAJ_OBJECTS) \
               -L$(LIBDIR) $(NETCDFLIB) $(ZLIB) $(BZLIB) $(FLIBS_PTRAJ)

$(NETCDFLIB): ../../netcdf_config.log
	cd ../../netcdf/src && $(MAKE) install

$(LIBDIR)/arpack.a:
	cd ../../arpack && $(MAKE) install

$(LIBDIR)/lapack.a:
	cd ../../lapack && $(MAKE) $(LAPACK)

$(LIBDIR)/blas.a:
	cd ../../blas && $(MAKE) $(BLAS)

thermo.o:  ../../ptraj/thermo.f
	$(FC) -c $(FREEFORMAT_FLAG) $(FOPTFLAGS) $(FFLAGS) $(AMBERFFLAGS) -o $@ ../../ptraj/thermo.f

pubfft.o:  ../../ptraj/pubfft.f
	$(FC) -c $(FREEFORMAT_FLAG) $(FOPTFLAGS) $(FFLAGS) $(AMBERFFLAGS) -o $@ ../../ptraj/pubfft.f 

.c.o:
	$(CC) -c $(CPPTRAJ_FLAGS) -o $@ $<

.cpp.o:
	$(CXX) -c $(CPPTRAJ_FLAGS) -o $@ $<

clean:
	/bin/rm -f $(OBJECTS) $(PTRAJ_OBJECTS) cpptraj$(SFX)

uninstall:
	/bin/rm -f $(BINDIR)/cpptraj$(SFX)

# Header dependencies
include cpptrajdepend
